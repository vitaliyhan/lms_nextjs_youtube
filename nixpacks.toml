[phases.setup]
cmds = [
  "apt-get update",
  "apt-get install -y curl",
  "curl -fsSL https://deb.nodesource.com/setup_20.x | bash -",
  "apt-get install -y nodejs",
  "corepack enable",
  "corepack prepare pnpm@latest --activate"
]

[phases.install]
cmds = [
  "pnpm install --frozen-lockfile --ignore-scripts"
]

# Install Prisma CLI globally to avoid permission issues
[phases.prisma-setup]
cmds = [
  "pnpm add -g prisma",
  "pnpm install @prisma/client"
]
needs = ["install"]

[phases.prisma-generate]
cmds = [
  "prisma generate"
]
needs = ["prisma-setup"]

[phases.build]
cmds = [
  "pnpm run build"
]
needs = ["prisma-generate"]

[start]
cmd = "pnpm start"

[build.args]
NODE_ENV = "production"

[build.environment]
NODE_OPTIONS = "--max_old_space_size=4096"

[cache]
directories = [
  "/root/.cache/pnpm",
  "/root/.npm",
  ".next/cache",
  "node_modules/.prisma"
]